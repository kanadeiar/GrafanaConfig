IF OBJECT_ID('tempdb..#tempsetdata' ) IS NOT NULL DROP TABLE #tempsetdata;
CREATE TABLE #tempsetdata
(
id INT NOT NULL,
name VARCHAR(64) NOT NULL,
number INT NULL,
[status] INT NULL,
[link] INT NULL,
a INT NULL,
b INT NULL, 
c INT NULL,
d INT NULL,
e INT NULL,
f INT NULL,
g INT NULL,
h INT NULL,
i INT NULL,
k INT NULL,
CONSTRAINT PK_idTempSetDataId PRIMARY KEY (id),
);
INSERT INTO #tempsetdata(id,name,number,[status],link, a,b,c,d,e,f,g,h,i,k)
VALUES 
(1,'Novospasskoe',3,81686,81686, 81689,81686,81666,81690,81691,81665,NULL,NULL,NULL,NULL)
,(2,'Novospasskoe',7,80367,80367, NULL,80367,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(3,'Novospasskoe',20,40992,40992, 40995,40992,40969,58900,58901,40968,39255,NULL,NULL,NULL)
,(4,'Novospasskoe',21,81376,81376, 81379,81376,81356,81380,81381,81355,NULL,NULL,NULL,NULL)

,(5,'Golodyaevskoe',1,73508,73508, NULL,73508,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(6,'Golodyaevskoe',2,408689,408689, NULL,408689,NULL,NULL,NULL,NULL,412631,NULL,NULL,NULL)
,(7,'Golodyaevskoe',3,74223,74223, NULL,74223,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(8,'Golodyaevskoe',8,73576,73576, NULL,73576,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(9,'Golodyaevskoe',10,83805,83805, 83808,83805,83785,83809,83810,83784,NULL,408340,NULL,NULL)
,(10,'Golodyaevskoe',11,41583,41583, 41586,41583,41560,58895,58896,41559,NULL,413171,NULL,NULL)
,(11,'Golodyaevskoe',12,82223,82223, 82226,82223,82203,82227,82228,82202,82236,82233,NULL,NULL)
,(12,'Golodyaevskoe',13,411527,411527, 411530,411527,411507,411531,411532,411506,413713,NULL,NULL,NULL)
,(13,'Golodyaevskoe',25,83490,83490, NULL,83490,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(14,'Golodyaevskoe',26,62502,62502, 62505,62502,62482,62506,62507,62481,62896,65877,NULL,NULL)

,(15,'Repjevskoe',4,407269,407269, NULL,407269,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(16,'Repjevskoe',5,39869,39869, NULL,39869,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(17,'Repjevskoe',21,409684,409684, 409687,409684,83785,83809,83810,83784,NULL,408340,NULL,NULL)
,(18,'Repjevskoe',23,39963,39963, NULL,39963,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(19,'Repjevskoe',24,83168,83168, NULL,83168,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(20,'Repjevskoe',26,413624,413624, NULL,413624,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)

,(21,'Volodarskoe',1,34712,34712, 34715,34712,34689,50822,50823,34688,NULL,410929,NULL,NULL)
,(22,'Volodarskoe',2,34666,34666, 34669,34666,34643,40799,40797,34642,73587,412906,NULL,NULL)
,(23,'Volodarskoe',39,41447,41447, 41450,41447,41424,41451,69637,41423,NULL,NULL,NULL,NULL)
,(24,'Volodarskoe',41,69610,69610, 69613,69610,69588,69614,69589,69587,NULL,NULL,NULL,NULL)
,(25,'Volodarskoe',42,410858,410858, NULL,410858,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(26,'Volodarskoe',44,34949,34949, 34952,34949,34926,71894,71895,34925,NULL,NULL,NULL,NULL)
,(27,'Volodarskoe',45,83622,83622, NULL,83622,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(28,'Volodarskoe',46,407836,407836, NULL,407836,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(29,'Volodarskoe',47,407480,407480, 407483,407480,407460,407484,407485,407459,408776,NULL,NULL,NULL)
,(30,'Volodarskoe',49,39607,39607, NULL,39607,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(31,'Volodarskoe',10049,52971,52971, 52974,52971,52948,409445,52950,52947,NULL,NULL,NULL,NULL)

,(32,'Baranovskoe',3,410022,410022, 410025,410022,410000,410002,410001,409999,66781,413117,NULL,NULL)
,(33,'Baranovskoe',11,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,NULL,66508,NULL,NULL)
,(34,'Baranovskoe',15,410529,410529, 410532,410529,410507,410509,410508,410506,NULL,410402,NULL,NULL)
,(35,'Baranovskoe',16,411236,411236, 411239,411236,411214,411216,411215,411213,NULL,408510,NULL,NULL)
,(36,'Baranovskoe',19,87127,87127, 87130,87127,87105,87106,87107,87104,NULL,66205,NULL,NULL)
,(37,'Baranovskoe',20,87234,87234, 87237,87234,87212,410450,87214,87211,NULL,408285,NULL,NULL)
,(38,'Baranovskoe',21,87340,87340, 87343,87340,87318,87319,87320,87317,NULL,66201,NULL,NULL)
,(39,'Baranovskoe',22,410636,410636, 410639,410636,410614,410616,410615,410613,NULL,66203,NULL,NULL)

,(40,'Varvarovskoe',1,85694,85694, 85697,85694,85672,85673,85674,85671,NULL,65802,NULL,NULL)
,(41,'Varvarovskoe',2,85914,85914, NULL,85914,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(42,'Varvarovskoe',7,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,64755,NULL,NULL,NULL)
,(43,'Varvarovskoe',8,85859,85859, 85862,85859,85837,85838,85839,85836,NULL,412520,NULL,NULL)
,(44,'Varvarovskoe',11,85786,85786, 85789,85786,85764,85765,85766,85763,NULL,NULL,NULL,NULL)
,(45,'Varvarovskoe',22,85963,85963, 85966,85963,85941,85942,85943,85940,NULL,413292,NULL,NULL)
,(46,'Varvarovskoe',23,86022,86022, NULL,86022,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(47,'Varvarovskoe',24,408189,408189, NULL,408189,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(48,'Varvarovskoe',25,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,411694,413435,NULL,NULL)
,(49,'Varvarovskoe',26,86211,86211, 86214,86211,86189,88700,86191,86188,NULL,77808,NULL,NULL)
,(50,'Varvarovskoe',27,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,73611,73614,NULL,NULL)
,(51,'Varvarovskoe',29,86281,86281, 86284,86281,86259,86260,86261,86258,NULL,65832,NULL,NULL)
,(52,'Varvarovskoe',30,86351,86351, 86354,86351,86329,413755,86331,86328,38806,412296,NULL,NULL)
,(53,'Varvarovskoe',31,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,38808,71748,NULL,NULL)
,(54,'Varvarovskoe',32,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,69209,69630,NULL,NULL)
,(55,'Varvarovskoe',33,86421,86421, 86424,86421,86399,86400,86401,86398,68042,81701,NULL,NULL)
,(56,'Varvarovskoe',34,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,412100,412096,NULL,NULL)
,(57,'Varvarovskoe',36,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,73408,72886,NULL,NULL)
,(58,'Varvarovskoe',37,86561,86561, 86564,86561,86539,86540,86541,86538,NULL,NULL,NULL,NULL)
,(59,'Varvarovskoe',38,86631,86631, 86634,86631,86609,86610,86611,86608,NULL,412412,NULL,NULL)
,(60,'Varvarovskoe',40,86701,86701, 86704,86701,86679,88240,86681,86678,NULL,69074,NULL,NULL)
,(61,'Varvarovskoe',-1,86491,86491, 86494,86491,86469,86470,86471,86468,83737,83740,NULL,NULL)

,(62,'Verhozimskoe',6,57165,57165, NULL,57165,NULL,NULL,NULL,NULL,49668,NULL,NULL,NULL)
,(63,'Verhozimskoe',10,48565,48565, 48561,48565,48560,48562,48563,48559,NULL,76393,NULL,NULL)
,(64,'Verhozimskoe',12,410295,410295, NULL,410295,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(65,'Verhozimskoe',19,409423,409423, NULL,409423,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(66,'Verhozimskoe',20,49767,49767, 49763,49767,49762,49764,49765,49761,NULL,NULL,NULL,NULL)
,(67,'Verhozimskoe',22,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,NULL,81154,NULL,NULL)
,(68,'Verhozimskoe',23,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,NULL,76599,NULL,NULL)
,(69,'Verhozimskoe',33,409863,409863, NULL,409863,NULL,NULL,NULL,NULL,NULL,76676,NULL,NULL)
,(70,'Verhozimskoe',34,83991,83991, 83987,83991,83986,83988,83989,83985,NULL,84311,NULL,NULL)
,(71,'Verhozimskoe',59,49141,49141, 49137,49141,49136,49138,49139,49135,NULL,NULL,NULL,NULL)
,(72,'Verhozimskoe',60,409780,409780, NULL,409780,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(73,'Verhozimskoe',61,49815,49815, 49811,49815,49810,49812,49813,49809,NULL,NULL,NULL,NULL)
,(74,'Verhozimskoe',62,49863,49863, 49859,49863,49858,49860,49861,49857,NULL,412087,NULL,NULL)
,(75,'Verhozimskoe',63,405315,405315, 405311,405315,405310,405312,405313,405309,NULL,NULL,NULL,NULL)
,(76,'Verhozimskoe',64,50103,50103, 50099,50103,50098,50100,50101,50097,NULL,77037,NULL,NULL)
,(77,'Verhozimskoe',65,411410,411410, NULL,411410,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(78,'Verhozimskoe',67,412991,412991, 412987,412991,412986,412988,412989,412985,NULL,76883,NULL,NULL)
,(79,'Verhozimskoe',71,49237,49237, 49233,49237,49232,49234,49235,49231,NULL,77114,NULL,NULL)
,(80,'Verhozimskoe',72,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,77661,77191,NULL,NULL)
,(81,'Verhozimskoe',73,411988,411988, 411984,411988,411983,411985,411986,411982,NULL,411808,NULL,NULL)
,(82,'Verhozimskoe',74,48949,48949, 48945,48949,48944,48946,48947,48943,NULL,77268,NULL,NULL)
,(83,'Verhozimskoe',75,413081,413081, NULL,413081,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)
,(84,'Verhozimskoe',76,49093,49093, 49089,49093,49088,49090,49091,49087,NULL,81953,NULL,NULL)
,(85,'Verhozimskoe',77,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,NULL,80939,NULL,NULL)
,(86,'Verhozimskoe',79,48517,48517, 48513,48517,48512,48514,48515,48511,NULL,77345,NULL,NULL)
,(87,'Verhozimskoe',80,411877,411877, 411873,411877,411872,411874,411875,411871,NULL,NULL,NULL,NULL)
,(88,'Verhozimskoe',83,48661,48661, 48657,48661,48656,48658,48659,48655,NULL,77422,NULL,NULL)
,(89,'Verhozimskoe',84,48613,48613, 48609,48613,48608,48610,48611,48607,NULL,77499,NULL,NULL)
,(90,'Verhozimskoe',86,48901,48901, 48897,48901,48896,48898,48899,48895,NULL,77576,NULL,NULL)
,(91,'Verhozimskoe',87,NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,NULL,77653,NULL,NULL)
,(92,'Verhozimskoe',147,50199,50199, 50195,50199,50194,50196,50197,50193,NULL,408259,NULL,NULL)

,(93,'Komarovskoe',8,83552,83552, 83548,83552,83547,83549,83550,83546,83397,407898,NULL,NULL)
,(94,'Komarovskoe',22,68310,68310, 68306,68310,68305,68307,68308,68304,68333,NULL,NULL,NULL)
;
DECLARE @countsetdata INT;
SET @countsetdata = 94;
IF OBJECT_ID('tempdb..#tempdata' ) IS NOT NULL DROP TABLE #tempdata;
SELECT tmr.ItemID, tmi.Name, tmr.Value, tmr.[Time], tmr.Quality, tmr.Flags
INTO #tempdata
FROM riannon.telemetry.dbo.MasterSCADADataRaw tmr INNER JOIN riannon.telemetry.dbo.MasterSCADADataItems tmi
	ON (tmr.ProjectID=tmi.ProjectID AND tmr.Layer=1 AND tmi.ItemID=tmr.ItemID AND tmi.LastTime=tmr.[Time]);
DECLARE @id INT;
DECLARE @name VARCHAR(64);
DECLARE @number INT;
DECLARE @status INT, @link INT;
DECLARE @a INT, @b INT, @c INT, @d INT, @e INT, @f INT, @g INT, @h INT, @i INT, @k INT;
DECLARE @statusv INT, @linkv INT;
DECLARE @av FLOAT=NULL, @bv FLOAT=NULL, @cv FLOAT=NULL, @dv FLOAT=NULL, @ev FLOAT=NULL;
DECLARE @fv FLOAT=NULL, @gv FLOAT=NULL, @hv FLOAT=NULL, @iv FLOAT=NULL, @kv FLOAT=NULL;
DECLARE @ftmp FLOAT;
DECLARE @itmp INT;
DECLARE @ttmp DATETIME;
IF OBJECT_ID('tempdb..#tempresultdata' ) IS NOT NULL DROP TABLE #tempresultdata;
CREATE TABLE #tempresultdata
(
id INT NOT NULL,
name VARCHAR(64) NOT NULL,
number INT NULL,
[status] INT NULL,
[link] INT NULL,
a FLOAT NULL,
b FLOAT NULL, 
c FLOAT NULL,
d FLOAT NULL,
e FLOAT NULL,
f FLOAT NULL,
g FLOAT NULL,
h FLOAT NULL,
i FLOAT NULL,
k FLOAT NULL,
CONSTRAINT PK_idTempResultData PRIMARY KEY (id),
);
DECLARE @ik INT;
SET @ik=1;
WHILE @ik<=@countsetdata 
BEGIN
	SELECT @id=id,@name=name,@number=number,@status=[status],@link=link,@a=a,@b=b,@c=c,@d=d,@e=e,@f=f,@g=g,@h=h,@i=i,@k=k FROM #tempsetdata WHERE id=@ik;
	SET @statusv = NULL;
	IF (@status IS NOT NULL)
	BEGIN
		SET @ftmp = (SELECT Value FROM #tempdata WHERE ItemID=@status);
		IF (@ftmp>1) SET @statusv=1; ELSE SET @statusv=0;
	END
	SET @linkv=NULL;
	IF (@link IS NOT NULL)
	BEGIN
		--SET @ttmp = (SELECT [Time] FROM #tempdata WHERE ItemID=@link);
		--IF (@ttmp >= dateadd(hh,-48,getdate())) SET @linkv=1; ELSE SET @linkv=0;
		SET @itmp = (SELECT Quality FROM #tempdata WHERE ItemID=@link);
		IF (@itmp = 192) SET @linkv=1; ELSE SET @linkv=0;
	END
	SET @av = (SELECT Value FROM #tempdata WHERE ItemID=@a);
	SET @bv = (SELECT Value FROM #tempdata WHERE ItemID=@b);
	SET @cv = (SELECT Value FROM #tempdata WHERE ItemID=@c);
	SET @dv = (SELECT Value FROM #tempdata WHERE ItemID=@d);
	SET @ev = (SELECT Value FROM #tempdata WHERE ItemID=@e);
	SET @fv = (SELECT Value FROM #tempdata WHERE ItemID=@f);
	SET @gv = (SELECT Value FROM #tempdata WHERE ItemID=@g);
	SET @hv = (SELECT Value FROM #tempdata WHERE ItemID=@h);
	SET @iv = (SELECT Value FROM #tempdata WHERE ItemID=@i);
	SET @kv = (SELECT Value FROM #tempdata WHERE ItemID=@k);
	INSERT INTO #tempresultdata(id,name,number,[status],link,a,b,c,d,e,f,g,h,i,k)
	VALUES (@id,@name,@number,@statusv,@linkv,@av,@bv,@cv,@dv,@ev,@fv,@gv,@hv,@iv,@kv);
	SET @ik=@ik+1;
END
SELECT name,number,[status],link,ROUND(a,1)AS a,ROUND(b,1)AS b,ROUND(c,1)AS c,ROUND(d,1)AS d,ROUND(e,1)AS e,ROUND(f,1)AS f,ROUND(g,1)AS g,ROUND(h,1)AS h 
FROM #tempresultdata
--WHERE name LIKE '%Novospasskoe%'
--WHERE name LIKE '%Golodyaevskoe%'
--WHERE name LIKE '%Repjevskoe%'
--WHERE name LIKE '%Volodarskoe%'
--WHERE name LIKE '%Baranovskoe%'
--WHERE name LIKE '%Varvarovskoe%'
--WHERE name LIKE '%Verhozimskoe%'
--WHERE name LIKE '%Komarovskoe%'
ORDER BY id;

